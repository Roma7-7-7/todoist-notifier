name: Build and Release

on:
  push:
    branches:
      - main
    paths:
      - "cmd/**"
      - "internal/**"
      - "pkg/**"
      - "go.mod"
      - "go.sum"
      - ".github/workflows/release.yml"

jobs:
  test:
    name: Run Tests
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Set up Go
        uses: actions/setup-go@v6
        with:
          go-version: "1.25.x"

      - name: Run tests
        run: go test -v ./...

  build-and-release:
    name: Build and Release Binaries
    needs: test
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Set up Go
        uses: actions/setup-go@v6
        with:
          go-version: "1.25.x"

      - name: Get version info
        id: version
        run: |
          # Use commit SHA as version
          echo "version=$(git rev-parse --short HEAD)" >> $GITHUB_OUTPUT
          echo "timestamp=$(date -u +%Y%m%d-%H%M%S)" >> $GITHUB_OUTPUT
          echo "tag=v$(date -u +%Y%m%d-%H%M%S)-$(git rev-parse --short HEAD)" >> $GITHUB_OUTPUT

      - name: Build binaries
        run: make build-release VERSION=${{ steps.version.outputs.version }} BUILD_TIME=${{ steps.version.outputs.timestamp }}

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.version.outputs.tag }}
          name: Release ${{ steps.version.outputs.tag }}
          body: |
            Automated release from commit ${{ github.sha }}

            **Changes:**
            ${{ github.event.head_commit.message }}

            **Binaries:**
            - `todoist-notifier-lambda-arm.zip` - AWS Lambda deployment package (ARM64 for Graviton processors)
            - `todoist-notifier-daemon-amd64` - Daemon for AMD64/x86_64 EC2 instances (t3, m5, c5 families)
            - `todoist-notifier-daemon-arm64` - Daemon for ARM64 EC2 instances (t4g, m6g, c6g Graviton families)
            - `VERSION` - Build metadata with git commit info

            **Deployment:**

            **Lambda (AWS):**
            - Upload `todoist-notifier-lambda-arm.zip` to your Lambda function
            - Lambda must be configured for ARM64 architecture

            **Daemon (EC2):**
            - Download the appropriate binary for your instance architecture
            - AMD64 for traditional x86_64 instances (t3, m5, c5, etc.)
            - ARM64 for Graviton instances (t4g, m6g, c6g, etc.)
            - Replace existing binary and restart the service
          files: |
            bin/todoist-notifier-lambda-arm.zip
            bin/todoist-notifier-daemon-amd64
            bin/todoist-notifier-daemon-arm64
            bin/VERSION
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
